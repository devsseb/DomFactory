/** 
 * DomFactory v1.0.0
 * DOM element creation facilitor
 * https://github.com/devsseb/DomFactory
 * 
 * This Source Code Form is subject to the terms of the Mozilla Public
 * License, v. 2.0. If a copy of the MPL was not distributed with this
 * file, You can obtain one at http://mozilla.org/MPL/2.0/.
 */
"use strict";var DomFactory=function(){var e=[String,HTMLElement,Node,Array],t=new MutationObserver((function(e){if(i.length)for(var t=0;t<e.length;t++){for(var r=0;r<e[t].addedNodes.length;r++)if(e[t].addedNodes[r].nodeType!=Node.TEXT_NODE){for(var a=0;a<i.length;a++)o.inElement(e[t].addedNodes[r],i[a])&&(i[a].dispatchEvent(n),delete i[a]);if(!(i=i.filter((e=>e))).length)return}if(!i.length)return}}));t.observe(document,{childList:!0,subtree:!0});var n=new Event("append"),r=new Event("create"),i=[],o=function(e,t){this.layouts=e||{},this.apis=t||{}};o.prototype.addLayout=function(e,t){for(var n=e.split("."),r=this.layouts,i=0;i<n.length-1;i++)null==r[e=n[i]]&&(r[e]={}),r=r[e];return r[n[n.length-1]]=t,this},o.prototype.addApi=function(e,t){for(var n=e.split("."),r=this.apis,i=0;i<n.length-1;i++)null==r[e=n[i]]&&(r[e]={}),r=r[e];return r[n[n.length-1]]=t,this},o.prototype.getLayout=function(e){for(var t,n,i=e.split("."),a=Array.prototype.slice.call(arguments,1),l=-1;l<i.length;l++)if(-1==l?(t=this.layouts,n=this.apis):(t=t[i[l]],null!=n&&(n=n[i[l]])),"function"==typeof t&&(t=t.apply(this,a)),"function"==typeof n&&(n=n.apply(this,a)),null==t)return void console.error('[DomFactory] Layout "'+e+'" not found');n=n||{};var s=this.createElement(t),f=s;Array.isArray(f)||(f=[f]);for(l=0;l<f.length;l++)f[l].setAttribute("layout",e),o.elementApplyDefinition(f[l],{api:n}),f[l].dispatchEvent(r);return s.domfactoryinstance=this,s},o.createElement=o.prototype.createElement=function(e){return null==e&&(e={}),Array.isArray(e)?o.createElementFromArray(e):e instanceof HTMLElement?o.createElementFromElement(e):"string"==typeof e||e instanceof String?o.createElementFromString(e):o.createElementFromDefinition(e)},o.createElementFromArray=function(e){for(var t,n=[],r=0;t=e[r];r++)r==e.length-1&&e.domfactorydefinition&&("function"==typeof t.set?t=t.set(e.domfactorydefinition):(null==t.domfactorydefinition&&(t.domfactorydefinition={}),t.domfactorydefinition.assign(definition.domfactorydefinition))),n.push(o.createElement(t));return n},o.createElementFromElement=function(e){return null!=e.domfactorydefinition&&(o.elementApplyDefinition(o.getElementLastChild(e),e.domfactorydefinition),delete e.domfactorydefinition),e},o.createElementFromString=function(e){for(var t,n=/[> ]?(?:#\D[\w_-]*|\.[\w_-]+|\[([\w_-]+)(?:=(?:"([\s\S]*?)"|([\s\S]*?)))?\]|[\w_-]*)/g,r=null,i=null,a={};null!==(t=n.exec(e))&&t.index!=e.length;){var l=(f=t[0]).substr(0,1);if(">"!=l&&" "!=l||(i?i.children=a:r=a,i=a,a={},l=(f=f.substr(1)).substr(0,1)),"#"==l)a.id=f.substr(1);else if("."==l)a.class||(a.class=[]),a.class.push(f.substr(1));else if("["==l){var s=t[1],f="";void 0!==t[2]&&(f=t[2]),void 0!==t[3]&&(f=t[3]),a[s]=f}else f&&(a.tag=f)}return e instanceof String&&null!=e.domfactorydefinition&&o.definitionAssign(a,e.domfactorydefinition),i?i.children=a:r=a,o.createElement(r)},o.createElementFromDefinition=function(e){var t,n=null;return void 0!==e.selector?(t=o.createElement(e.selector),n=o.getElementLastChild(t)):t=n="text"==e.tag?document.createTextNode(""):document.createElement(e.tag||"div"),o.elementApplyDefinition(n,e),t},o.getElementLastChild=function(e){for(var t=e;t.lastElementChild;)t=t.lastElementChild;return t},o.definitionAssign=function(e,t){for(var n in t)Array.isArray(e[n])?(Array.isArray(t[n])||(t[n]=t[n].split(" ")),e[n]=e[n].concat(t[n])):"object"==typeof e[n]?Object.assign(e[n],t[n]):e[n]=t[n];return e},o.elementApplyDefinition=function(e,t){for(var n in"string"==typeof t&&((t={})[arguments[1]]=arguments[2]),t){var r=t[n];if("function"==typeof r&&"on"!=n.substr(0,2)&&(r=r.call(e,e)),"tag"!=n&&"selector"!=n)if("children"!=n)if("class"!=n)if("style"!=n||"string"==typeof r)if("text"!=n)if("html"!=n)if("on"!=n.substr(0,2))if("api"!=n)n=n.replace(/[A-Z]/g,(e=>"-"+e.toLowerCase())),e.setAttribute(n,r);else for(var a in null==e.api&&(e.api={}),r)"on"==a.substr(0,2)&&o.elementApplyDefinition(e,a,r[a]),e.api[a]=r[a].bind(e);else"append"==(n=n.substr(2))&&i.push(e),e.addEventListener(n,r,{options:{capture:!0}});else e.innerHTML=r;else e.nodeType==Node.TEXT_NODE?e.nodeValue=r:e.innerText=r;else for(var a in r)e.style[a]=r[a];else Array.isArray(r)&&(r=r.join(" ")),e.className&&(e.className+=" "),e.className+=r;else{Array.isArray(r)||(r=[r]);for(var l,s=o.createElement(r),f=0;l=s[f];f++)l instanceof Node&&e.appendChild(l)}}return e},o.inElement=function(e,t){if(e==t)return!0;for(var n=0;n<e.children.length;n++)if(o.inElement(e.children[n],t))return!0;return!1};for(var a,l=0;a=e[l];l++)a.prototype.set=function(e,t){var n=this;return"string"==typeof this&&(n=new String(this)),n.domfactorydefinition&&null!=n.domfactorydefinition.children?n.domfactorydefinition.children=n.domfactorydefinition.children.set(e,t):(null==e&&(e={}),n.domfactorydefinition||(n.domfactorydefinition={}),"object"!=typeof e&&((e={})[arguments[0]]=t),DomFactory.definitionAssign(n.domfactorydefinition,e)),n},a.prototype.append&&(a.prototype.originalAppend=a.prototype.append),a.prototype.append=function(e){if(this.originalAppend){if(e instanceof Node)return this.originalAppend(e);if(Array.isArray(e)){for(var t=0;t<e.length;t++)this.append(e[t]);return}}return Array.isArray(e)||(e=Array.prototype.slice.call(arguments)),this.set("children",e)},a.prototype.on=function(e,t){var n=arguments[0];"string"==typeof n&&((n={})[e]=t);var r=this;for(var e in n)r=r.set("on"+e,n[e]);return r},a.prototype.createElement=function(e,t){return null!=e&&this.set.apply(this,arguments),o.createElement(this)},a.prototype.getLayout=function(e){if(this.domfactoryinstance)return this.domfactoryinstance.getLayout.apply(this.domfactoryinstance,arguments);console.error("[DomFactory] This element does not come from a layout")};return o.parseSelector=function(e){return e=e.replace(/ยง([\w-]+)/g,(function(e,t){return'[layout="'+t.replace(/[A-Z]/g,(e=>"."+e.toLowerCase()))+'"]'}))},["querySelector","querySelectorAll","closest","matches"].forEach((e=>{var t=HTMLElement.prototype[e];HTMLElement.prototype[e]=function(e){return t.call(this,o.parseSelector(e))}})),o}();